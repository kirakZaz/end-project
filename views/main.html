<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <link rel="stylesheet" type="text/css" href="styles/style.css" /></head>

    </head>
<body>
<header class="header">
    <span class="logo">
      <img src="styles/nodejs.png"/>
      <span>By KZ</span>
    </span>
    <a class="linkText" href="/users.html">Go to Users</a>
</header>
<div class="mainDiv">
    <div class="videoDiv">
        <video src="" id="video"  autoplay="true"></video>
    </div>
    <div class="chatDiv">
        <input placeholder="write a message" type="text" id="message">\
        <button type="button" name="button" onclick="sendMessage()">Send</button>\
        <div id="message-container"></div>
    </div>

<!--style="width:700px; height: 350px;"-->
    <canvas style="display:none;" id="preview"></canvas>
</div>

<div id="logger" class="logger"></div>
</body>
<!--    <script  type="text/javascript" src="/socket.scripts/videoCam.js"></script>-->
<script type="text/javascript">
    async function GetUser(id) {
        const response = await fetch("/api/users/" + id, {
            method: "GET",
            headers: { Accept: "application/json" },
        });
        if (response.ok === true) {
            const user = await response.json();
            return user.name
        }
    }
    const canvas = document.getElementById("preview");
    const context = canvas.getContext('2d');

    canvas.width = 900;
    canvas.height = 700;

    context.width = canvas.width;
    context.height = canvas.height;

    const video = document.getElementById("video");

    const socket = io('http://localhost:5000',{transports : ['websocket', 'polling'] })

    function logger(msg){
        $('#logger').text(msg);
    }

    function loadCamera(stream){
    try {
        video.srcObject = stream;
    } catch (error) {
        video.src = URL.createObjectURL(stream);
    }
        logger("Camera connected");
    }
        function loadFail(){
        logger("Camera not connected");
    }

    function viewVideo(video,context){
        context.drawImage(video,0,0,context.width,context.height);
        socket.emit('stream',canvas.toDataURL('image/webp'));
    }

    $(function(){
        navigator.getUserMedia = ( navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msgGetUserMedia );

        if(navigator.getUserMedia){
            navigator.getUserMedia({video: true, audio: false},loadCamera,loadFail);
        }

        setInterval(function(){
            viewVideo(video,context);
        },5);
    });
 // ------------ chat ---------

    var cookieValue = document.cookie.replace(/(?:(?:^|.*;\s*)user\s*\=\s*([^;]*).*$)|^.*$/, "$1");
    console.log('ccokie',socket)


    const username = GetUser(cookieValue)
    // function setUsername() {
    //     socket.emit('setUsername', document.getElementById('name').value);
    // };
    let user;
    // socket.on('userExists', function(data) {
    //     console.log('data', data)
    //     document.getElementById('error-container').innerHTML = data;
    // });

    // socket.on('userSet', function(data) {
    //     user = data.username;
    //     const chatMessages = document.getElementById('chatMessages')
    //     chatMessages.innerHTML = '<input placeholder="write a message" type="file" id="message">\
    //      <button type="button" name="button" onclick="sendMessage()">Send</button>\
    //      <div id = "message-container"></div>';
    // });

    function sendMessage() {
        const msg = document.getElementById('message').value;
        if(msg) {
            console.log('msg', msg)
            console.log('user', user)
            socket.emit('msg', {message: msg, user: user});
        }
    }

    socket.on('newmsg', function(data) {
        if(user) {
            document.getElementById('message-container').innerHTML += '<div><b>' +
                data.user + '</b>: ' + data.message + '</div>'
        }
    })
</script>
</html>